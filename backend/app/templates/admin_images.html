{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<h1 class="mb-3">Image library</h1>

<form method="POST" enctype="multipart/form-data" class="mb-3">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="mb-2">
    <label class="form-label">Upload an image</label>
    <input class="form-control" type="file" name="image" accept=".jpg,.jpeg,.png,.webp" required>
  </div>
  <button class="btn btn-primary" type="submit">Upload</button>
</form>

<hr class="my-4">

<h2 class="mb-3">Homepage image slots (4)</h2>

<form method="POST" action="{{ url_for('admin.update_homepage_slots') }}" class="mb-3">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="slot-grid">
    {% for n in [1,2,3,4] %}
      {% set key = 'slot' ~ n %}
      <div class="slot-card">
        <h3 class="h5 mb-2">Slot {{ n }}</h3>

        <select class="form-select" name="{{ key }}">
          <option value="">(Empty)</option>
          {% for img in images %}
            <option value="{{ img._id }}" {% if slots and slots[key] and img._id == slots[key] %}selected{% endif %}>
              {{ img.object_name }}
            </option>
          {% endfor %}
        </select>

        {% if slots and slots[key] %}
          {% set current = (images | selectattr("_id", "equalto", slots[key]) | list) %}
          {% if current and current[0].url %}
            <div class="img-preview">
              <img src="{{ current[0].url }}" alt="Slot {{ n }} image">
            </div>
          {% endif %}
          <p class="mt-2 mb-0"><small class="text-muted">Currently set</small></p>
        {% else %}
          <p class="mt-2 mb-0"><small class="text-muted">Empty</small></p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <button class="btn btn-success" type="submit">Save slot selection</button>
</form>

<hr class="my-4">

<h2 class="mb-3">Uploaded images</h2>

<div class="img-grid">
  {% for img in images %}
    <div class="img-card">
      <div class="img-media">
        <img src="{{ img.url }}" alt="Uploaded image">
      </div>

      <div class="mt-2">
        <small class="text-muted">{{ img.object_name }}</small>
      </div>

      <form method="POST" action="{{ url_for('admin.hide_uploaded_image') }}" class="mt-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="image_id" value="{{ img._id }}">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Hide from library</button>
      </form>

      <form method="POST" action="{{ url_for('admin.delete_uploaded_image') }}" class="mt-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="image_id" value="{{ img._id }}">
        <button class="btn btn-outline-danger btn-sm" type="submit">Delete from bucket</button>
      </form>
    </div>
  {% else %}
    <p>No images yet.</p>
  {% endfor %}
</div>
{% endblock %}
