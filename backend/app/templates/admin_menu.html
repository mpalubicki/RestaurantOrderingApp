{% extends "base.html" %}

{% block content %}
  <h1 class="mb-3">Administrator Menu</h1>
  <p class="text-muted">Select an option below.</p>

  <div class="list-group mb-4">
    <a class="list-group-item list-group-item-action" href="{{ url_for('admin.upload_menu_image_page') }}">
      Upload menu image
    </a>

    <a class="list-group-item list-group-item-action" href="{{ url_for('admin.images_library') }}">
      Image library (assign homepage images)
    </a>

    <a class="list-group-item list-group-item-action" href="{{ url_for('admin.orders_dashboard') }}">
      View customer orders
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h5 mb-0">Admin APIs (JSON)</h2>
        <button class="btn btn-outline-primary btn-sm" type="button" id="js-refresh-api">
          Refresh
        </button>
      </div>

      <p class="text-muted mt-2 mb-3">
        Quick links to the admin JSON endpoints for orders and confirmations.
      </p>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="border rounded p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Recent Orders API</div>
                <div class="text-muted small">GET /api/admin/orders</div>
              </div>
              <span class="badge text-bg-secondary" id="js-orders-count">—</span>
            </div>

            <div class="mt-3 d-flex gap-2">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('api.api_admin_orders') }}"
                 target="_blank" rel="noopener">
                Open JSON
              </a>
            </div>

            <div class="mt-2 text-muted small" id="js-orders-status"></div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="border rounded p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Order Confirmations API</div>
                <div class="text-muted small">GET /api/admin/order-confirmations</div>
              </div>
              <span class="badge text-bg-secondary" id="js-conf-count">—</span>
            </div>

            <div class="mt-3 d-flex gap-2">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('api.api_admin_order_confirmations') }}"
                 target="_blank" rel="noopener">
                Open JSON
              </a>
            </div>

            <div class="mt-2 text-muted small" id="js-conf-status"></div>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <div class="text-muted small">
        Tip: refresh after placing an order  
      </div>
    </div>
  </div>

  <script>
    async function fetchJson(url) {
      const resp = await fetch(url, { credentials: "same-origin" });
      const text = await resp.text();
      let data = null;
      try { data = JSON.parse(text); } catch (e) {}
      return { ok: resp.ok, status: resp.status, data, raw: text };
    }

    async function refreshAdminApiSummary() {
      const ordersCountEl = document.getElementById("js-orders-count");
      const ordersStatusEl = document.getElementById("js-orders-status");
      const confCountEl = document.getElementById("js-conf-count");
      const confStatusEl = document.getElementById("js-conf-status");

      ordersStatusEl.textContent = "Loading…";
      confStatusEl.textContent = "Loading…";

      const ordersUrl = "{{ url_for('api.api_admin_orders') }}";
      const confUrl = "{{ url_for('api.api_admin_order_confirmations') }}";

      const [ordersRes, confRes] = await Promise.all([
        fetchJson(ordersUrl),
        fetchJson(confUrl),
      ]);

      if (ordersRes.ok && ordersRes.data && Array.isArray(ordersRes.data.orders)) {
        ordersCountEl.textContent = ordersRes.data.orders.length;
        ordersCountEl.className = "badge text-bg-success";
        ordersStatusEl.textContent = "OK";
      } else {
        ordersCountEl.textContent = "!";
        ordersCountEl.className = "badge text-bg-danger";
        ordersStatusEl.textContent = `Failed (${ordersRes.status})`;
      }

      if (confRes.ok && confRes.data && Array.isArray(confRes.data.results)) {
        confCountEl.textContent = confRes.data.results.length;
        confCountEl.className = "badge text-bg-success";
        confStatusEl.textContent = "OK";
      } else {
        confCountEl.textContent = "!";
        confCountEl.className = "badge text-bg-danger";
        confStatusEl.textContent = `Failed (${confRes.status})`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("js-refresh-api");
      btn.addEventListener("click", refreshAdminApiSummary);
      refreshAdminApiSummary();
    });
  </script>
{% endblock %}

